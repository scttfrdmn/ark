version: '3.9'

services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: ark-postgres
    environment:
      POSTGRES_USER: ark
      POSTGRES_PASSWORD: ark_dev_password
      POSTGRES_DB: ark
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ark"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ark-network

  # Backend service
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        VERSION: ${VERSION:-dev}
        COMMIT_SHA: ${COMMIT_SHA:-unknown}
        BUILD_DATE: ${BUILD_DATE:-unknown}
    container_name: ark-backend
    environment:
      PORT: "8080"
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_USER: ark
      DB_PASSWORD: ark_dev_password
      DB_NAME: ark
      DB_SSLMODE: disable
      MIGRATIONS_PATH: /app/migrations
      LOG_LEVEL: info
    ports:
      - "8081:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    networks:
      - ark-network
    restart: unless-stopped

  # Agent service (optional - typically runs on host)
  # Uncomment if you want to test agent in Docker
  # agent:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.agent
  #     args:
  #       VERSION: ${VERSION:-dev}
  #       COMMIT_SHA: ${COMMIT_SHA:-unknown}
  #       BUILD_DATE: ${BUILD_DATE:-unknown}
  #   container_name: ark-agent
  #   ports:
  #     - "8737:8737"
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8737/api/system/health"]
  #     interval: 30s
  #     timeout: 3s
  #     start_period: 5s
  #     retries: 3
  #   networks:
  #     - ark-network
  #   restart: unless-stopped

volumes:
  postgres_data:
    driver: local

networks:
  ark-network:
    driver: bridge
